@page
@model Boitoan.Pages.Admin.IndexModel
@{
    ViewData["Title"] = "Admin Dashboard";
}

<h2>Admin Dashboard</h2>
<div class="row">
    <div class="col-md-4">
        <div class="card text-white bg-primary mb-3">
            <div class="card-header">Total Users</div>
            <div class="card-body">
                <h3 class="card-title">@Model.TotalUsers</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-success mb-3">
            <div class="card-header">Total Tests</div>
            <div class="card-body">
                <h3 class="card-title">@Model.TotalTests</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-white bg-info mb-3">
            <div class="card-header">Tests Taken</div>
            <div class="card-body">
                <h3 class="card-title">@Model.TotalHistories</h3>
            </div>
        </div>
    </div>
</div>

<section>
    <h2>Test Taken History</h2>
    <table class="table" id="history-table">
        <thead>
            <tr>
                <th>Test Name</th>
                <th>User Name</th>
                <th>Result</th>
                <th>Distinct Answers</th>
            </tr>
        </thead>
        <tbody id="history-body">
        </tbody>
    </table>
    <div id="loading" style="display:none;">Loading...</div>
</section>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/testMonitorHub")
            .build();

        connection.on("ReceiveQuestionSelection", function (userId, questionId) {
            // Highlight the selected question
            document.querySelectorAll("#question-list li").forEach(li => li.style.background = "");
            const selected = document.getElementById("question-" + questionId);
            if (selected) {
                selected.style.background = "#ffeeba";
                document.getElementById("current-selection").innerText = `User ${userId} selected question ${questionId}`;
            }
        });

        connection.start().catch(err => console.error(err.toString()));

        let skip = 0;
        const take = 5;
        let loading = false;
        let allLoaded = false;

        async function loadMore() {
            if (loading || allLoaded) return;
            loading = true;
            document.getElementById('loading').style.display = 'block';
            const res = await fetch(`/admin?handler=Stats&skip=${skip}&take=${take}`);
            const data = await res.json();
            if (data.length < take) allLoaded = true;
            skip += data.length;
            const tbody = document.getElementById('history-body');
            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${item.testName}</td>
                                <td>${item.userName}</td>
                                <td>${item.result}</td>
                                <td>${
                                    item.answerCounts
                                        ? Object.entries(item.answerCounts).map(([k, v]) => `${k}: ${v}`).join(', ')
                                        : ''
                                }</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('loading').style.display = 'none';
            loading = false;
        }

        // Initial load
        loadMore();

        // Infinite scroll
        window.addEventListener('scroll', () => {
            if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
                loadMore();
            }
        });
    </script>
}